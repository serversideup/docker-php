{
	# Global Caddy configuration
	admin {$CADDY_ADMIN:off}
	auto_https {$CADDY_AUTO_HTTPS:off}

	http_port {$CADDY_HTTP_PORT:8080}
	https_port {$CADDY_HTTPS_PORT:8443}

	skip_install_trust

	frankenphp {
		{$FRANKENPHP_CONFIG}
	}

	log {
		format console
	}

	{$CADDY_GLOBAL_OPTIONS}
}

# Common app logic; reused across all SSL modes
(app-common) {
	root * {$CADDY_APP_PUBLIC_PATH:/var/www/html/public}

	encode zstd br gzip

	log {
		format console
		output stdout
	}

	# Healthcheck endpoint
	@health {
		path /healthcheck
	}
	respond @health "OK" 200
	log_skip @health

	php_server
	file_server

	import performance
	import security 

	{$CADDY_SERVER_EXTRA_DIRECTIVES}
}

(performance) {
	# Static files
	@static {
		path *.js *.css *.jpg *.jpeg *.gif *.png *.ico *.cur *.gz *.svg *.svgz *.mp4 *.mp3 *.ogg *.ogv *.webm *.htc *.woff2 *.woff
	}

	# Short-lived static files
	@staticshort {
		path *.json *.xml *.rss
	}

	# 1 year, similar to h5bp nginx config
	header @static Cache-Control "public, immutable, stale-while-revalidate, max-age=31536000"

	# 1 hour max, gets validated with the origin server
	# https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control#no-cache
	header @staticshort Cache-Control "no-cache, max-age=3600"
}

(security) {
	# Reject dot files and certain file extensions
	@rejected path *.bak *.conf *.dist *.fla *.ini *.inc *.inci *.log *.orig *.psd *.sh *.sql *.swo *.swp *.swop */.*

	# Return 403 Forbidden for rejected files
	respond @rejected 403
}

# Pull in the per-mode listeners (off|mixed|full)
import ssl-mode/{$SSL_MODE:off}.caddyfile

# Add your web servers here
import caddyfile.d/*.caddyfile
