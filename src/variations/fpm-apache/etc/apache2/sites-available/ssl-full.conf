<VirtualHost *:${APACHE_HTTP_PORT}>
    # Configure ServerAdmin and ServerName
    ServerName localhost
    ServerAdmin webmaster@localhost

    # Turn on rewrite engine
    RewriteEngine On
    
    # Redirect traffic from localhost to https://localhost:${APACHE_HTTPS_PORT}
    RewriteCond %{SERVER_NAME} =localhost
    RewriteRule ^ https://%{SERVER_NAME}:${APACHE_HTTPS_PORT}%{REQUEST_URI} [END,NE,R=permanent]

    # Redirect all other traffic to https://host:443
    RewriteCond %{SERVER_NAME} !=localhost
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    # Set environment variable for healthcheck requests
    SetEnvIf Request_URI "^${HEALTHCHECK_PATH}$" dontlog

    # Configure Log Settings
    LogFormat "%l %u %t %v %a \"%r\" %>s %b" comonvhost
    ErrorLog /dev/stderr
    CustomLog /dev/stdout comonvhost env=!dontlog
    LogLevel ${LOG_OUTPUT_LEVEL}

</VirtualHost>

<VirtualHost *:${APACHE_HTTPS_PORT}>
    Include /etc/apache2/vhost-templates/https.conf
</VirtualHost>